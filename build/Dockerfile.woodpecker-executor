FROM golang:1.24.11-alpine AS build

WORKDIR /app

COPY . .

RUN apk add --no-cache git ca-certificates

RUN mkdir -p /app/bin

ENV CGO_ENABLED=0
RUN go build \
    -o bin \
    ./cmd/woodpecker-executor-server

EXPOSE 4000

FROM gcr.io/distroless/base-debian12
COPY --from=build /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/
COPY --from=build /app/bin/* /app/bin/
CMD ["/app/bin/woodpecker-executor-server"]
